# Глава 17. Тестирование модулей и приложений

#### Что обсуждается в этой главе?

* Запуск тестов с использованием node-tap
* Использование модуля Node assert
* Тестирование модуля на примере

---

Для минимизации числа ошибок, с которыми сталкиваются пользователи при использовании вашего ПО, необходимо тестировать написанный код. Вы можете производить некоторые из этих тестов вручную, но оптимально, вам нужна программа, которая автоматизирует данный процесс.

Автоматизированное тестирование — один из самых важных методов, который улучшает качество программного кода. Его цель — создать набор тестов, которые покрывают весь код и включают тестирование как основных, так и непредвиденных ситуаций. Некоторые методологии, такие как TDD (test-driven development, разработка через тестирование) призывают сначала создавать тесты, а затем реализовывать код, который заставляет их работать.

Независимо от вашей цели, написание автоматизированных тестов — хорошее вложение. Эта глава показывает, как тестировать ваши модули и программы Node.

## Запуск тестов

Процесс тестирования включает в себя определение самого теста, затем запуск специальной программы, которая компилирует и запускает эти тесты, выводя результаты.

Для Node.js и JavaScript существует много таких программ. В этой главе обсуждается модуль node-tap. Я выбрал его по нескольким причинам: он простой, легко поддерживает асинхронное тестирование, и формат вывода основан на стандарте.

Вы можете установить node-tap, включив его внутрь секции devDependencies вашего файла package.json:

    {
        "name": "MyApp",
        "version": "0.1.0",
        "devDependencies": {
            "tap": "*"
        }
    }

Затем выполните следующую команду:

    $ npm install

Когда NPM загрузит и установит node-tap и его зависимости, вы можете начинать его использование.

#### Примечание:

Если вы определяете зависимость в свойстве devDependencies вашего файла package.json, вы говорите своей программе, что данные зависимости нужны только при разработке.

Это хорошее место для хранения всех зависимостей, которые используются только для разработки и тестирования ваших приложений.

Когда вы устанавливаете ваше приложение в рабочей среде, вы можете использовать параметр -production для пропуска установки модулей, перечисленных в секции devDependencies:

    $ npm install -production

---

### Написание тестов

Чтобы создавать тесты, сначала необходимо настроить директорию, в которой вы будете размещать скрипты тестов. Как правило, данная директория обычно называется `tests` и содержит по одному файлу теста на модуль.

Создайте первый скрипт теста в этой директории. В нем нужно импортировать модуль `tap` и получить конструктор тестов:

    var test = require('tap').test;

Теперь вы можете определить свой первый тест. Для этого необходимо указать имя теста и функцию, содержащую код теста:

    test('сложение 2 и 2 работает', function (t) {
        t.equal(2+2, 4, '2+2 должно быть 4');
        t.end();
    });

В этом коде вы объявляете тест с именем `addition of 2 and 2 works` и затем передаете функцию, которая содержит код теста. Функция получает аргумент `t`, который содержит объект контроля для данного теста. С помощью этого объекта вы можете тестировать свои ожидания и завершать текущий тест. Node-tap поддерживает асинхронные тесты. Это значит, что если вы выполняете операции ввода-вывода, тест продолжит выполняться и после завершения функции. Node-tap завершает выполнение теста, только когда вы вызываете его метод `end`.

### Запуск теста

Сохраните файл, созданный в предыдущем разделе, и назовите его `my_test.js`. Вы можете запустить этот тест, выполнив скрипт теста напрямую:

    $ node my_test

Вы должны получить примерно такой вывод:

    # сложение 2 и 2 работает
    ok 1 2+2 должно быть 4
    
    1..1
    # tests 1
    # pass 1
    
    # ok

## Использование модуля утверждений

Для построения валидного теста необходим способ проверки, что получаемые результаты соответствуют вашим ожиданиям. В предыдущем примере для этого использовались встроенные функции утверждений модуля `node-tap` — о которых вы узнаете позже — но сейчас вы можете использовать встроенный Node-модуль `assert`.

### Использование модуля assert

Node использует встроенный модуль `assert` в своих тестах. Node предоставляет для использования данный модуль, значит, вы можете использовать его для проверки ожиданий внутри своих тестов.

Чтобы использовать модуль `assert`, импортируйте его в вашем скрипте теста:

    var assert = require('assert');

Теперь вы можете использовать функции утверждений. Каждая из этих функций устанавливает некоторое ожидание, и если данное ожидание не выполнится, будет возбуждено исключение.

Для начала, вы можете протестировать некоторое значение на истинность:

    var a = true;
    assert(a);

#### Примечание:

В JavaScript значение, которое проходит проверку в инструкции if, является истинным. Истинные значения обычно включают все возможные значения, минус ложные значения, такие как:

* `false`
* `null`
* `undefined`
* Пустая строка `""`
* Число `0`
* Число `NaN`

---

Этой и другим функциям утверждений вы также можете передавать сообщение в последнем аргументе, содержащее больше информации, которая будет показана, если тест провалится:

    assert(a, 'a должно быть истинно');

Вы также можете использовать следующий псевдоним для проверки истинности значения:

    assert.ok(a, 'a должно быть истинно');

`assert` может тестировать равенство значений двумя способами: поверхностный или глубокий. Поверхностное равенство просто тестирует два переданных объекта, и не тестирует равенство внутренних объектов. Глубокое равенство, наоборот, рекурсивно тестирует все вложенные объекты. Поверхностное тестирование обычно используется для сравнения примитивных значений, таких как строки и числа, в то время как глубокое равенство обычно используется для сравнения двух объектов.

Вы можете проверять поверхностное равенство так:

    assert.equal(a, 10, 'a должно быть 10');

Данное действие эквивалентно оператору равенства JavaScript (`==`), а значит, следующее утверждение верно:

    assert.equal('10', 10);

Вы также можете использовать утверждение НЕравенства, которое эквивалентно оператору неравенства JavaScript (`!=`). Следующее утверждение провалится:

    assert.notEqual('10', 10);

Модуль `assert` также поддерживает строгое сравнение, эквивалентное оператору строгого равенства JavaScript (`===`). Следующее утверждение провалится:

    assert.strictEqual('10', 10, 'строка 10 должна быть равна 10');

а следующее утверждение выполнится:

    assert.notStrictEqual('10', 10, 'строка 10 не должна быть равна числу 10');

До сих пор мы проверяли поверхностное равенство. При данном типе проверки равенства, если вы тестируете два объекта, ссылки этих объектов должны указывать на один и тот же объект для прохождения теста:

    assert.equal({a:1}, {a:1});

Предыдущее утверждение провалится:

    AssertionError: {"a":1} == {"a":1}

Здесь поверхностное сравнение проваливается, потому что даже при кажущейся идентичности, это на самом деле два разных объекта.

Если вы хотите сравнить *свойства* объектов, используйте глубокое сравнение.

Для глубокого сравнения, вы можете использовать функцию `assert.deepEqual`. Следующее сравнение выполнится:

    var obj = {b:1, a:[1, 2, 3, 4]};
    assert.deepEqual(objm {a:[1, 2, 3, 4], b:1});

Вы можете также использовать данную функцию для сравнения дат:

    var a = new Date(),
        b = new Date();
    assert.deepEqual(a, b);

С версии 0.7 вы также можете сравнивать таким образом регулярные выражения. Если вы используете Node 0.7 или выше, следующее сравнение выполнится:

    assert.deepEqual(/a/ig, /a/gi);

Функция deepEqual проверяет только перечисляемые свойства объекта, а значит, если два объекта имеют различные свойства, но все перечисляемые свойства объектов равны, они не будут распознаны как различные. Например, следующее сравнение пройдет:

    var EventEmitter = require('events').EventEmitter;
    var ee = new EventEmitter();
    assert.deepEqual(ee, {});

Это происходит, потому что следующее утверждение выполняется:

    assert.strictEqual(Object.keys(ee).length, 0);

### Использование встроенных функций утверждений модуля node-tap

Модуль node-tap также предоставляет функции утверждений. Используя их вместо определенных в модуле ядра Node, вы можете получить преимущества от встроенных test count metrics, сообщений об ошибках, и объединенного отчета node-tap. Функции тестирования представляют собой нечто похожее на встроенные функции модуля `assert`, но они достаточно отличаются, чтобы рассматривать их отдельно.

Используя t.ok() и t.notOk(), вы можете проверять истинность:

    test("истинность чисел", function (t) {
        t.ok(1, '1 должно быть истинно');
        t.notOk(0, '0 не должно быть истинно');
        t.end();
    });

Вы также можете проверять строгое равенство, используя функцию t.equal:

    text("проверка сумм", function (t) {
        var a = 2 + 2;
        t.equal(a, 4, '2 + 2 должно быть равно 4');
        t.notEqual(a, '4', '2 + 2 не должно быть равно строке "4"');
        t.end();
    });

Функция t.equal также используется для поверхностной проверки. Следующий тест провалится:

    test("равенство объектов", function(t) {
        var a = {a:1};
        t.equal(a, {a:1});
        t.end();
    });

В этом случае вы должны использовать тест на эквивалентность. Данный тест выполнится:

    test("эквивалентность объектов", function(t) {
        var a = {a:1, b:2};
        t.equivalent(a, {b:2, a:1});
        t.end();
    });

Вы также можете проверять объекты на сходство. Например, вы можете проверить, содержит ли объект набор атрибутов, и затем проверить их значения. Для этого вы можете использовать t.simular:

    test("сходство объектов", function(t) {
        a = {a:1, b:2};
        t.similar(a, {a:1});
        t.similar('abc', 'abc');
        t.similar(10, 10);
        t.end();
    });

Проверка сходства объектов также работает с числовыми и строковыми объектами:

    test("сходство объектов", function(t) {
        t.similar('abc', 'abc');
        t.similar(10, 10);
        t.end();
    });

Кроме того, вы можете проверять типы объектов с помощью t.type():

    test("типы объектов", function(t) {
        t.type(1, "number");
        t.type('abc', 'string');
        t.type({}, Object);
        var EventEmitter = require('events').EventEmitter;
        var ee = new EventEmitter();
        t.type(ee, EventEmitter);
        t.type(ee, Object);
        t.end();
    });

В предыдущем примере видно, что вы можете проверять, создан ли объект с помощью некоторого конструктора, передавая конструктор в функцию утверждения t.type().

## Тестирование вашего асинхронного модуля

Теперь, когда вы знаете как использовать node-tap, вы можете построить пример интересного модуля для тестирования. Чтобы сделать его еще более интересным, данный модуль будет выполнять некоторые операции ввода-вывода, так что вы сможете произвести некоторые асинхронные тесты.

Данный модуль складывает два целых числа путем вызова удаленной HTTP-службы. Дла начала, создайте HTTP-сервер, который берет два целых числа и складывает их:

    var parse = require('url').parse;

    require('http').createServer(function(req, res) {
        params = parse(req.url, true).query;
        var a = parseInt(params.a, 10);
        var b = parseInt(params.b, 10);
        var result = a + b;
        res.end(JSON.stringify(result));
    }).listen(8080);

Создайте две директории: одну с именем `client` и другую с именем `server`. Затем сохраните данный код в файле `server/sum_server.js`, который запускается следующим образом:

    $ node server/sum_server.js

Это запустит HTTP-службу сложения чисел.

Затем создайте модуль клиента, который использует данную службу и предоставляет клиентский API. Для начала укажите зависимости в манифесте package.json внутри директории `client`:

    {
    "name": "sum-client",
    "version": "1.0.0",
    "dependencies": {
        "request": "*"
        }
    }

Теперь вы должны установить все зависимости, которые в данном случае включают только модуль `request`:

    $ npm install
    request@2.10.0 ./node_modules/request

Теперь вы можете разместить модуль клиента в файле `index.js` внутри клиентской директории, скопировав следующий код в файл `sum_client.js` внутри клиентской директории.

    var request = require('request');
    
    function sum(a, b, callback) {
        var options = {
            uri: 'http://localhost:8080/',
            qs: {
                a: a,
                b: b
            }
        };
        
        request(options, function(err, res, body) {
            var result;
            if (err) {
                return callback(err);
            }
            try {
                result = JSON.parse(body);
            } catch(err) {
                return callback(err);
            }
            return callback(null, result);
        });
    }
    
    module.exports = sum;

Этот модуль просто экспортирует функцию, которая предоставляет службу суммы.

Теперь вы готовы протестировать данный модуль. Создайте директорию `test` на том же уровне, что и директории `client` и `server`.

Затем создайте манифест package.json внутри данной директории, и укажите в нем `tap` как зависимость при разработке:

    {
        "name": "sum-tests",
        "version": "1.0.0",
        "devDependencies": {
            "tap": "*"
        }
    }

Перейдите в директорию `tests` и установите зависимости:

    $ cd tests
    $ npm install
    tap@0.3.0 node_modules/tap
    ├── buffer-equal@0.0.0
    ├── deep-equal@0.0.0
    ├── mkdirp@0.3.3
    ├── slide@1.1.3
    ├── nopt@2.0.0 (abbrev@1.0.3)
    ├── difflet@0.2.1 (charm@0.0.8, traverse@0.6.3)
    └── runforcover@0.0.2 (bunker@0.1.2)
    $ cd ..

Затем сохраните следующий код в файле `tests/sum.js`.

    var sum = require('../client/sum_client');
    var test = require('tap').test;
    
    test('складывает 1 и 2', function(t) {
        sum(1, 2, function(err, result) {
            t.notOk(err, 'no error');
            t.equal(result, 3, '1 + 2 should be equal to 3');
            t.end();
        });
    });
    
    test('складывает 5 и 0', function(t) {
        sum(5, 0, function(err, result) {
            t.notOk(err, 'no error');
            t.equal(result, 5, '5 + 0 should be equal to 3');
            t.end();
        });
    });
    
    test('sums 5 and -2', function(t) {
        sum(5, -2, function(err, result) {
            t.notOk(err, 'no error');
            t.equal(result, 3, '5 + -2 should be equal to 3');
            t.end();
        });
    });

В этом файле теста, вы сначала импортируете файл клиентский модуль суммы, который вы используете ниже в определении тестов.

Затем вы выполняете набор тестов, вызывая функцию sum клиентского модуля с разными аргументами для каждого теста, проверяя отсутствие ошибки, соответствие результатов ожиданиям, и, наконец, завершая тест.

Убедившись, что ваш сервер сумм все еще запущен, запустите эти тесты:

    $ node tests/sum.js

Вы получите вывод успешного запуска теста:

    ...
    1..6
    # tests 6
    # pass 6
    # ok

## Резюме

Тестирование ваших приложений и модулей следует рассматривать не только как хорошую практику, но и как обязательное условие для минимизации дефектов кода, который вы производите. В Node, среди прочих, для запуска тестов используется модуль node-tap.

Для проверки ожиданий в ваших тестах, вы можете использовать встроенный в Node модуль `assert`, или использовать функции, предоставляемые модулем node-tap.